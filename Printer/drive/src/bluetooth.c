/**
  ******************************************************************************
  * @file    x.c
  * @author  Application Team  
  * @version V0.0.1
  * @date    2016-3-18
  * @brief   BLUETOOTHÏà¹Ø³ÌÐò¡£
  ******************************************************************************
  * @attention
  *
  * THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS
  * WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE
  * TIME. AS A RESULT, STMICROELECTRONICS SHALL NOT BE HELD LIABLE FOR ANY
  * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING
  * FROM THE CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE
  * CODING INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.
  *
  * <h2><center>&copy; COPYRIGHT 2016</center></h2>
  ******************************************************************************
  */

/* Includes ------------------------------------------------------------------*/
#include	"bluetooth.h"
#include	"extgvar.h"
#include	"debug.h"
#include  "string.h"
#include  "maintain.h"
/* Private typedef -----------------------------------------------------------*/
/* Private functions ---------------------------------------------------------*/
extern FLASH_Status Flash_Inside_BufWrite(const u8* pBuffer, uint32_t WriteAddr, uint16_t NumByteToWrite);
extern void Flash_Inside_ReadByte(uint8_t* pBuffer, uint32_t ReadAddr, uint16_t NumByteToRead);

//2.0 4.0Ë«Ä£À¶ÑÀÄ£¿é
u8	*I482E_DefaultParameter[] ={        
 								//"AT+BIND=0",				    //µØÖ·°ó¶¨£¬£½0²»°ó¶¨

 								//"AT+CLEARADDR",				 //Çå³ý°ó¶¨µØÖ·
 								//"AT+ROLE=0",				   //Éè±¸½ÇÉ«£¨Ö÷´ÓÄ£Ê½£©£¬0´ÓÄ£Ê½
								"AT+SSP=0",				       //ÊÇ·ñ¼øÈ¨£¬£½0¼øÈ¨»
								"AT+NAME=T801_BT_Printer",	//Ãû³Æ  
 								"AT+CLASS=040680",	        //ÀàÐÍ
								"AT+PIN=1234",			        //ÃÜÂë  
								"AT+BAUD=115200",			      //²¨ÌØÂÊ 2016.09.23 ¸ÄÎª115200
	              "AT+BTMODE=1",			        //2016.09.14 ÉèÖÃ¾²Ä¬Ä£Ê½
	              "AT+MULTICONN=0",          //2020.05.28  ¹Ø±Õ¶àÁ¬½Ó
	              "AT+IDLE=10000",				 //ivtµÄBR2141es ²»ÄÜÉèÖÃÎª0È¡ÏûÐÝÃß
                                
  };

//½ðê±3.0BTÄ£¿é
// u8	*BC04_DefaultParameter[] ={
// 								"AT+BIND=0",				   //µØÖ·°ó¶¨£¬£½0²»°ó¶¨

// 								"AT+CLEARADDR",				 //Çå³ý°ó¶¨µØÖ·
// 								"AT+ROLE=0",				   //Éè±¸½ÇÉ«£¨Ö÷´ÓÄ£Ê½£©£¬0´ÓÄ£Ê½
// 								"AT+AUTH=1",				   //ÊÇ·ñ¼øÈ¨£¬£½1¼øÈ¨

// 								"AT+NAME=T801_BT_Printer",	   //Ãû³Æ   
// 								"AT+CLASS=040680",			       //ÀàÐÍ
// 								"AT+PASSWORD=1234",			       //ÃÜÂë
// 								"AT+BAUD=230400",			         //²¨ÌØÂÊ
// 	              "AT+LINKPLCY=1,6,6,0,300",     //Ìá¸ßÀ¶ÑÀ´«Êä
// 	              "AT+SNIFF=0,0,0,0",					   //Ìá¸ßÀ¶ÑÀ´«Êä 
// 	};

// u8	*JOBT4_DefaultParameter[] ={
// 								"AT+BIND=0",				   //µØÖ·°ó¶¨£¬£½0²»°ó¶¨

// 								"AT+CLEARADDR",				 //Çå³ý°ó¶¨µØÖ·
// 								"AT+ROLE=0",				   //Éè±¸½ÇÉ«£¨Ö÷´ÓÄ£Ê½£©£¬0´ÓÄ£Ê½
// 								"AT+AUTH=1",				   //ÊÇ·ñ¼øÈ¨£¬£½1¼øÈ¨

// 								"AT+NAME=T801_BT_Printer",	   //Ãû³Æ   
// 								//"AT+CLASS=040680",			     //ÀàÐÍ
// 								"AT+PASSWORD=123456",			     //ÃÜÂë
// 								"AT+BAUD=115200",			         //²¨ÌØÂÊ 115200
// 	              "AT+LINKPLCY=1,6,6,0,300",     //Ìá¸ßÀ¶ÑÀ´«Êä
// 	};


/* Private function prototypes -----------------------------------------------*/
/* Private functions ---------------------------------------------------------*/

/*Extern Private functions ---------------------------------------------------------*/
extern void DelayUs(u32 DelayNumber);
extern u8	ReadInBuffer( void );
extern void SPI_FLASH_BlockErase(u32 SectorAddr); 
extern void UpLoadData(u8 *DataBuf, u32 Length);				//ÉÏ´«Êý¾Ý
extern void PrintString( u8 *Str );
extern void GoDotLine(u32 DotLineNumber);
/**
  * @brief  Test to see if a key has been pressed on the HyperTerminal
  * @param key: The key pressed
  * @retval : 1: Correct
  *   0: Error
  */
	
/*******************************************************************************
* Function Name  : º¯ÊýÃû
* Description    : ³õÊ¼»¯´®¿Ú¿ØÖÆ¹Ü½Å
* Input          : ÊäÈë²ÎÊý
* Output         : Êä³ö²ÎÊý
* Return         : ·µ»Ø²ÎÊý
*******************************************************************************/
void	InitBluetoothPort(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	
	/************* ÉèÖÃÀ¶ÑÀ´®¿Ú¶Ë¿Ú ****************************/
	RCC_APB2PeriphClockCmd(BT_RCC_APB2Periph_GPIO, ENABLE);
	RCC_APB1PeriphClockCmd(BT_RCC_APB1Periph_USART, ENABLE);
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);
	GPIO_PinRemapConfig(GPIO_Remap_USART2, ENABLE);   //ÖØÓ³Éä´®¿Ú2
	
	GPIO_InitStructure.GPIO_Pin		=	BT_UART_RX;
	GPIO_InitStructure.GPIO_Mode	= GPIO_Mode_IN_FLOATING;	//´®¿Ú¸´ÓÃÊäÈë  
	GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_50MHz;
	GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);
	
	GPIO_InitStructure.GPIO_Pin		=	BT_UART_TX;
	GPIO_InitStructure.GPIO_Mode	= GPIO_Mode_AF_PP;		   //´®¿Ú¸´ÓÃÊä³ö
	GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);
	
	GPIO_InitStructure.GPIO_Pin =  BT_UART_CTS;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;  			
	GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);
	
	GPIO_InitStructure.GPIO_Pin		= BT_UART_RTS;	    	   //¶ÔÀ¶ÑÀÖÃÃ¦
  GPIO_InitStructure.GPIO_Mode	= GPIO_Mode_Out_PP;
  GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);
	GPIO_SetBits(BT_UART_PORT, BT_UART_RTS );							 //ÉèÖÃÎªÃ¦
	
	GPIO_InitStructure.GPIO_Pin =  BT_WIFI_TYPE ;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;	 //³õÊ¼»¯Îª¸¡¿Õ
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
	GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);	
	
	GPIO_InitStructure.GPIO_Pin =  BT_LINK ;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;	  		
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_10MHz;
	GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);	
	
	GPIO_InitStructure.GPIO_Pin = BT_RST;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;			
  GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);	
	GPIO_ResetBits(BT_UART_PORT, BT_RST );							  //ÉèÖÃµÍ
	
	GPIO_InitStructure.GPIO_Pin = BT_SET ;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;   		//ÍÆÍìÊä³ö
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(BT_UART_PORT, &GPIO_InitStructure);
	GPIO_ResetBits(BT_UART_PORT, BT_SET );								//ÉèÖÃµÍ
}

/*******************************************************************************
* Function Name  : º¯ÊýÃû
* Description    : ³õÊ¼»¯À¶ÑÀ´®¿Ú
* Input          : ÊäÈë²ÎÊý
* Output         : Êä³ö²ÎÊý
* Return         : ·µ»Ø²ÎÊý
*******************************************************************************/
void	InitBTUsart(void)
{	
	RCC_APB1PeriphClockCmd(BT_RCC_APB1Periph_USART, ENABLE);		  //Ê¹ÄÜ´®¿ÚÊ±ÖÓ

	USART_BT_InitStructure.USART_BaudRate = 115200;               
	USART_BT_InitStructure.USART_WordLength = USART_WordLength_8b;
	USART_BT_InitStructure.USART_StopBits = USART_StopBits_1;
	USART_BT_InitStructure.USART_Parity = USART_Parity_No;
	USART_BT_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
	USART_BT_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;

	USART_Init(BT_UART, &USART_BT_InitStructure);
	USART_Cmd(BT_UART, ENABLE);	  
	USART_ITConfig(BT_UART, USART_IT_RXNE, DISABLE);		          //¹Ø±ÕBT¡ªUSART½ÓÊÕÖÐ¶ÏDISABLE
	USART_ClearFlag(BT_UART,USART_FLAG_TC); 	
	
}


uint32_t SerialKeyPressed(uint8_t *key)
{
	static u16 Timeout=0;
	while(1)
	{  
			if ( USART_GetFlagStatus(BT_UART, USART_FLAG_RXNE) != RESET)
			{
					*key = (uint8_t)BT_UART->DR;	
					Timeout = 0;   
					return 1;
			}
			else
			{
					Timeout++;
					DelayUs(1);          
			}
			if(Timeout >25000)
			{
					*key = 0;
					Timeout = 0;
					return 0;
			}
	}
}

uint32_t SerialKeyTimeout(uint8_t *key)
{
    static u16 Timeout=0;
    while(1)
    {  
        if ( USART_GetFlagStatus(BT_UART, USART_FLAG_RXNE) != RESET)
        {
            *key = (uint8_t)BT_UART->DR;	
            Timeout = 0;   
            return 1;
        }
        else
        {
            Timeout++;
            DelayUs(1);          
        }
        if(Timeout >25000)
        {
            *key = 0;
            Timeout = 0;
					  BtTimeOut =1;   //2016.09.14  ³¬Ê±
            return 1;
        }
    }
}

/*******************************************************************************
* Function Name  : void ReadSrt(u8 *Str)
* Description    : ´ÓÊäÈë»º³åÇø¶ÁÈ¡ÒÔ0A½áÊøµÄ×Ö·û´®,×Ö·û´®×î´ó³¤¶ÈÎª255×Ö·û
* Input          : Srt:×Ö·û´®µØÖ·
* Output         : None
* Return         : None
*******************************************************************************/
void ReadSrt( u8 *Str )
{
	u8	ch;
	u32 i;

	while(!SerialKeyTimeout(&ch));			 //µÈ´ý½ÓÊÕµ½×Ö·û
	if(ch ==0x0d)							 //È¥³ýµô¿ªÊ¼µÄ¡°0D¡¢0A¡±
	{
		while(!SerialKeyTimeout(&ch));
		while(!SerialKeyTimeout(&ch));
	}
	Str[0]=ch;
	for(i=1; i< 45;i++)
	{
		while(!SerialKeyTimeout(&ch));
 		Str[i]=ch;
		if(Str[i] == 0x0a)
		{
			i++;
			break;
		}
	}
	Str[i]=0;	
}
/*******************************************************************************
* Function Name  : void USART_SendSrt(USART_TypeDef* USARTx, *u8 Str)
* Description    : ´ÓÖ¸¶¨µÄ´®¿Ú·¢ËÍÒ»×Ö·û´®
* Input          : USARTX£¬´®¿ÚºÅ£¬Srt:×Ö·û´®µØÖ·
* Output         : None
* Return         : None
*******************************************************************************/
void USART_SendStr(USART_TypeDef* USARTx, u8 *Str)
{
	while(1)
	{
		if( *Str)
		{
			USART_SendData(USARTx, *Str);
			Str++;
		}
		else
			break;
	}
}


/*******************************************************************************
* Function Name  : 	OpenSetupBluetooth
* Description    : ½øÈëÀ¶ÑÀÉèÖÃÄ£Ê½
				           µ÷ÓÃÕâ¸öº¯ÊýµÄÇ°ÌáÊÇÈ·±£ÓÐÀ¶ÑÀ	
* Input          : None
* Output         : None
* Return         : 0 = ³É¹¦£¬ 1 = Ê§°Ü
*******************************************************************************/
uint8_t OpenSetupBluetooth(void)
{
	uint8_t DataBuf[40];	

	USART_ITConfig(BT_UART, USART_IT_RXNE, DISABLE);		

	
	if(BluetoothStruct.Type == DMBT)                                     //Ë«Ä£Ä£¿éÉèÖÃÄ£Ê½²¨ÌØÂÊ¹Ì¶¨Îª230400
	{
		 USART_BT_InitStructure.USART_BaudRate = 115200;						//2016.09.23
	}
	USART_Init(BT_UART, &USART_BT_InitStructure);
		

	

	
	if(BluetoothStruct.Type == DMBT) 				//Ë«Ä£I482E
	{
		BT_RST_LOW;
		SysDelay1mS(20);     						//ÖÃµÍIOºóÐèÒª¸´Î»Ä£¿é½øÈëÉèÖÃÄ£Ê½
		BT_RST_HIGH; 
		SysDelay1mS(2000);
	}
  else                                                //ÆäËûÄ£¿é
	{
		BT_RST_LOW;
 		SysDelay1mS(20);     						//ÖÃµÍIOºóÐèÒª¸´Î»Ä£¿é½øÈëÉèÖÃÄ£Ê½
 		BT_RST_HIGH; 
    SysDelay1mS(3000);
	}
	return 0;											   
}

/*******************************************************************************
* Function Name  : 	CloseSetupBluetooth
* Description    : ÍË³öÀ¶ÑÀÉèÖÃÄ£Ê½
* Input          : None
* Output         : None
* Return         : 0 = ³É¹¦£¬ 1 = Ê§°Ü
*******************************************************************************/
uint8_t CloseSetupBluetooth(void)
{

	
	 if(BluetoothStruct.Type == DMBT)		//2016.09.21
	 {
		  if(BtParaReloadFlag==1)
			{
        BtParaReloadFlag = 0;							
				BT_RST_LOW;
		    SysDelay1mS(20);     						//ÖÃµÍIOºóÐèÒª¸´Î»Ä£¿é½øÈëÉèÖÃÄ£Ê½
		    BT_RST_HIGH; 
		    SysDelay1mS(1000);
			}	
			USART_BT_InitStructure.USART_BaudRate = 115200;
	 }
	 else
	 {
			USART_BT_InitStructure.USART_BaudRate = 230400;
   }	 
	 USART_Init(BT_UART, &USART_BT_InitStructure); 			  //´®¿ÚÉèÖÃ
	 USART_ITConfig(BT_UART, USART_IT_RXNE, ENABLE);		  //´ò¿ªUSART1½ÓÊÕÖÐ¶Ï
	 return 0;										
}


/*******************************************************************************
* Function Name  : uint32_t BC04_ReadCommand
* Description    : ¶ÁÀ¶ÑÀÄ£¿é²ÎÊý.ÒýÈëµÄ¾ÉÊ½¹¤×÷·½Ê½£¬ºóÐøÐèµ÷Õû
* Input          : CommandString£ºÖ¸Áî×Ö·û´®£¬Buffer£º·µ»ØµÄ²ÎÊý×Ö·û´®Ö¸Õë
* Output         : Buffer£º·µ»ØµÄ²ÎÊý
* Return         : =1 error ,=0 ok    2014.06.18
*******************************************************************************/
uint8_t BC04_ReadCommand(uint8_t *CommandString,uint8_t *Buffer)
{
	uint8_t DataBuf[400];
	uint8_t Status =0;

	USART_SendStr(BT_UART,CommandString);

	ReadSrt(Buffer);						 //¶ÁÈ¡Ö¸ÁîÈ·ÈÏ

	if(strcmp(Buffer,"ERROR\r\n") == 0)
	{
		Status = 1;
    g_tError.UR_ErrorFlag |= 0x10;
	}
	else
	{
		if(strcmp(Buffer,"OK\r\n") == 0)
			ReadSrt(Buffer);			//OKÔÚÇ°,¶ÁÈ¡·µ»ØµÄ²ÎÊý
		else
			ReadSrt(DataBuf);			//OKÔÚºó£¬¶ÁÈ¡·µ»ØµÄOK
	}
	return Status;
}
/*******************************************************************************
* Function Name  : uint32_t BC04_SetCommand
* Description    : ¸øÀ¶ÑÀÄ£¿é·¢ËÍÉèÖÃÖ¸Áî£¬¼æÈÝ½ðê±Ä£¿é
* Input          : CommandString£ºÖ¸Áî×Ö·û´®
* Output         : None
* Return         : =1 error ,=0 ok   2014.06.18
*******************************************************************************/
uint8_t BC04_SetCommand(uint8_t *CommandString)
{
	uint8_t DataBuf[40];

	USART_SendStr(BT_UART,CommandString);
  USART_SendStr(BT_UART,"\r\n");
    
	ReadSrt(DataBuf);						//¶ÁÈ¡Ö¸ÁîÈ·ÈÏ
	if(strcmp(DataBuf,"ERROR\r\n") == 0)
  {
    g_tError.UR_ErrorFlag |= 0x10;
		return 1;
  }
	else
  {
		return 0;
  }
}
/*******************************************************************************
* Function Name  : void Judge_BT_BM57(void)
* Description    : Í¨¹ýÐÅºÅÏßµçÆ½ÅÐ¶ÏÀ¶ÑÀÄ£¿éÐÍºÅ
				           BluetoothStruct.Type 1,JOBT4 4.0Ä£¿é£»2,GCJO 3.0Ä£¿é£»3,DMBT,I482ESË«Ä£Ä£¿é£»4,DLBT,Ò»ÍÏ¶àBTÄ£¿é	
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void Judge_BT_Type(void)
{
	uint32_t	i;
	uint8_t  Temp;
	
	GPIO_InitTypeDef GPIO_InitStructure;

	for(i=0;i<80;i++)				   			//µÈ´ý½ðê±Ä£¿é¸´Î»Íê³É
	{
		DelayMs(20);								  //´Ë´¦Î´¿ªµÎ´ð¶¨Ê±Æ÷ ²»ÓÃSysDelay1mSº¯Êý
		if(!READ_BT_CTS)						  //Èç¹ûÓÐ½ðê±Ä£¿é£¬ÔòÄ£¿é¸´Î»ºóBT_CTSÐÅºÅÎªµÍ  ³õÊ¼»¯Ê±ÎªÉÏÀ­ÊäÈë
		{	
			break;
		}
	}
  if(!READ_BT_CTS)								      //CTSÎªµÍµçÆ½			
	{				
    g_tInterface.BT_Type = 1;			      //ÓÐÀ¶ÑÀÄ£¿é	
	}
	else										              //
	{	
    g_tInterface.BT_Type = 0;
	}
}
/*******************************************************************************
* Function Name  : void BTDMReadSrt(void)
* Description    : Ë«Ä£Ä£¿éÍ¨ÐÅ¶ÁÈ¡×Ö·û´®			            	
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
u8 BTDMReadSrt( u8 *Str )         
{
	u8	ch;
	u32 i,j=0;

	while(!SerialKeyTimeout(&ch))			 //µÈ´ý½ÓÊÕµ½×Ö·û
  {
		j++;
		if(j>=100)
			return 1;
  }
	if(ch ==0x0d)							        //È¥³ýµô¿ªÊ¼µÄ¡°0D¡¢0A¡±
	{
		while(!SerialKeyTimeout(&ch));
		while(!SerialKeyTimeout(&ch));
	}
	
	Str[0]=ch;
	for(i=1; i< 35;i++)
	{
		while(!SerialKeyTimeout(&ch));
 		Str[i]=ch;
		if(Str[i] == 0x0a)
		{
			i++;
			break;
		}
	}
	Str[i]=0;	 
	if(BtTimeOut==1)  //2016.09.14 À¶ÑÀ³¬Ê±´¦Àí
	{	
		BtTimeOut =0;
		return 1;
	}	
  else
	{	
		return 0;
	}	
	
}
/*******************************************************************************
* Function Name  : void I482_ReadCommand(void)
* Description    : Ë«Ä£Ä£¿é¶ÁÈ¡Ö¸Áî
				            	
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
uint8_t I482_ReadCommand(uint8_t *CommandString,uint8_t *Buffer)  
{
	uint8_t DataBuf[400];
	uint8_t Status =0;

	USART_SendStr(BT_UART,CommandString);

	Status = BTDMReadSrt(Buffer);						 //¶ÁÈ¡Ö¸ÁîÈ·ÈÏ
  if(Status == 1)
    return Status;

	if(strcmp(Buffer,"ERROR\r\n") == 0)
	{
		Status = 1;
    g_tError.UR_ErrorFlag |= 0x10;
	}
	else
	{
		if(strcmp(Buffer,"OK\r\n") == 0)
			ReadSrt(Buffer);			//OKÔÚÇ°,¶ÁÈ¡·µ»ØµÄ²ÎÊý
		else
			ReadSrt(DataBuf);			//OKÔÚºó£¬¶ÁÈ¡·µ»ØµÄOK
	}
	return Status;
}
/*******************************************************************************
* Function Name  : void I482_SetCommand(void)
* Description    : Ë«Ä£Ä£¿éÉèÖÃÖ¸Áî			            	
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
uint8_t I482_SetCommand(uint8_t *CommandString) 
{
	uint8_t DataBuf[40];

	USART_SendStr(BT_UART,CommandString);
	USART_SendStr(BT_UART,"\r");
    
	ReadSrt(DataBuf);						//¶ÁÈ¡Ö¸ÁîÈ·ÈÏ
	if(strcmp(DataBuf,"ERROR\r\n") == 0)
	{
			g_tError.UR_ErrorFlag |= 0x10;
			return 1;
	}
	else
	{
		return 0;
	}
}

/*******************************************************************************
* Function Name  : u8 InitJOBT(void)
* Description    : À¶ÑÀÄ£¿é£¬ÏÈ¶ÁÄ£¿é´®¿Ú²¨ÌØÂÊ£¬Èç¹û²»Îª230400£¬ÔòÈÏÎª¸Ã
*                  Ä£¿éÎªÐÂµÄÄ£¿é£¬Ôò¶ÔÆä°´Ä¬ÈÏ·½Ê½½øÐÐÉèÖÃ¡£				
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
// u8 InitJOBT(void)
// {
// 	u8 	DataBuf[40], *p, BT_Status=0, Status;  //´òÓ¡»úÉè±¸ÀàÐÍ040680
// 	u32	i;	
//   
// 	for(i=0; i<3; i++)
// 	{
// 		BT_Status = BC04_ReadCommand("AT+BAUD?\r\n", DataBuf);
// 		if(BT_Status == 0)	 						//²éÑ¯À¶ÑÀÄ£¿éµÄ²¨ÌØÂÊ
// 			break;
// 	}
// 	if(BT_Status ==0)		  						//·µ»Ø´íÎó
// 	{
// 		if(BluetoothStruct.Type == GCJO)
// 		{	
// 			if((strcmp(DataBuf,"+BAUD:230400\r\n") != 0) || BluetoothStruct.reInitFlag)	//Èç¹û²»ÊÇ230400£¬Ôò¶ÔÄ£¿é³õÊ¼»¯
// 			{
// 				for (i=0;i<10;i++)
// 				{
// 					BT_Status = BC04_SetCommand( &BC04_DefaultParameter[i][0]);//Êä³öÀ¶ÑÀÄ£¿éÖ¸Áî
// 					if(BT_Status == 1)		
// 						break;							//³ö´íÍË³ö
// 				}
// 			}
//   	}
// 		else if(BluetoothStruct.Type == JOBT4)
// 		{	
// 			if((strcmp(DataBuf,"+BAUD:115200\r\n") != 0) || BluetoothStruct.reInitFlag)	//Èç¹û²»ÊÇ115200£¬Ôò¶ÔÄ£¿é³õÊ¼»¯
// 			{
// 				for (i=0;i<8;i++)
// 				{
// 					BT_Status = BC04_SetCommand( &JOBT4_DefaultParameter[i][0]);//Êä³öÀ¶ÑÀÄ£¿éÖ¸Áî
// 					if(BT_Status == 1)		
// 						break;							//³ö´íÍË³ö
// 				}
// 			}
//   	}
// 	}  
//         
// 	if(BT_Status ==0)
// 	{
// 		Status = BC04_ReadCommand( "AT+LADDR?\r\n", DataBuf);	 //²éÑ¯À¶ÑÀÄ£¿éµÄµØÖ·
// 		if(Status == 0)
// 		{
// 			for(i=0; i<6;i++)
// 			{
// 				BluetoothStruct.Laddr[3*i]= DataBuf[7+2*i];
// 				BluetoothStruct.Laddr[3*i+1]= DataBuf[7+2*i+1];
// 				BluetoothStruct.Laddr[3*i+2]= ':';
// 			}
// 			BluetoothStruct.Laddr[17] = 0;
// 		}
// 		else
// 		{
// 			BT_Status =1;
// 			BluetoothStruct.Laddr[0] = 0;
// 		}
// 		Status = BC04_ReadCommand( "AT+VERSION?\r\n", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ°æ±¾
// 		if(Status == 0)
// 		{
// 			p =strchr(DataBuf, 'B');
// 			if(p==0)
// 			{
// 				p =strchr(DataBuf, ':');
// 				strcpy(BluetoothStruct.Version, p+1);
//         p=strchr(BluetoothStruct.Version,0x0a);
//         if(p!=0)
// 				{	
//           *p=0;
//         }             
// 			}
// 			else
//       {
// 				strcpy(BluetoothStruct.Version, p);
//         p=strchr(BluetoothStruct.Version,0x0a);
//         if(p!=0)
// 				{	
//           *p=0;
// 				}	
//       }                
// 		}
// 		else
// 		{
// 			BT_Status =1;
// 			BluetoothStruct.Version[0] = 0;
// 		}
// 		Status = BC04_ReadCommand( "AT+PASSWORD?\r\n", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄÃÜÂë
// 		if(Status == 0)
// 		{
// 			p =strchr(DataBuf, ':');
// 			strcpy(BluetoothStruct.Password, p+1);               
// 			p=strchr(BluetoothStruct.Password,0x0a);
// 			if(p!=0)
// 			{
// 				*p=0;
// 			}            
// 		}
// 		else
// 		{
// 			BT_Status =1;
// 			BluetoothStruct.Password[0] = 0;
// 		}
// 		Status = BC04_ReadCommand( "AT+BIND?\r\n", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ°ó¶¨×´Ì¬
// 		if(Status == 0)
// 		{
// 			p =strchr(DataBuf, ':');
// 			p =strchr(p+1, '0');   //Èç¹û²é²»µ½¶ÔÓ¦×Ö·û·µ»ØNULL   ½ðê±0±íÊ¾²»°îµÏµØÖ·£¬1°ó¶¨µØÖ·            
// 			if(p == NULL)          //1  °ó¶¨µØÖ·               
// 			{
// 					BluetoothStruct.Bind = 1;
// 			}
// 			else                   //²ÎÊý¡®0¡¯±íÊ¾²»°ó¶¨µØÖ·
// 			{
// 					BluetoothStruct.Bind = 0;
// 			}            
// 		}
// 		else
// 		{
// 			BT_Status =1;
// 		}
// 		Status = BC04_ReadCommand( "AT+AUTH?\r\n", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ¼øÈ¨×´Ì¬
// 		if(Status == 0)
// 		{
// 			p =strchr(DataBuf, ':');
// 			p =strchr(p, '0');   //Èç¹û²é²»µ½¶ÔÓ¦×Ö·û·µ»ØNULL
// 			p =strchr(DataBuf, '0');
// 			if(p == NULL)          //²ÎÊý¡®1¡¯±íÊ¾ÐèÒª¼øÈ¨  
// 			{
// 					BluetoothStruct.Auth = 1;
// 			}
// 			else                   //²ÎÊý¡®0¡¯±íÊ¾²»ÐèÒª¼øÈ¨
// 			{
// 					BluetoothStruct.Auth = 0;
// 			}
// 		}
// 		else
// 		{
// 			BT_Status =1;
// 		}
// 		Status = BC04_ReadCommand( "AT+NAME?\r\n", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄÃû³Æ
// 		if(Status == 0)
// 		{
// 			p =strchr(DataBuf, ':');
// 			strcpy(BluetoothStruct.Name, p+1);
// 			p=strchr(BluetoothStruct.Name,0x0a);
// 			if(p!=0)
// 			{
// 					*p=0;
// 			}
// 		}
// 		else
// 		{
// 			BT_Status =1;
// 			BluetoothStruct.Name[0] = 0;
// 		}
//     
//     if(BluetoothStruct.Type == GCJO)    
// 		{	
// 			Status = BC04_ReadCommand( "AT+CLASS?\r\n", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ°ó¶¨×´Ì¬
// 			if(Status == 0)
// 			{
// 				p =strchr(DataBuf, ':');
// 				strcpy(BluetoothStruct.Class, p+1);
// 				p=strchr(BluetoothStruct.Class,0x0a);
// 				if(p!=0)
// 				{
// 						*p=0;
// 				}
// 			}
// 			else
// 			{
// 				BT_Status =1;
// 				BluetoothStruct.Class[0] = 0;
// 			}
// 		}
// 	}
//     return BT_Status;
// }


/*******************************************************************************
* Function Name  : u8 InitI482EBT(void)
* Description    : ³õÊ¼»¯Ë«Ä£Ä£¿é ÏÈ¶ÁÄ£¿é´®¿Ú²¨ÌØÂÊ£¬Èç¹û²»Îª230400£¬ÔòÈÏÎª¸Ã
*                 Ä£¿éÎªÐÂµÄÄ£¿é£¬Ôò¶ÔÆä°´Ä¬ÈÏ·½Ê½½øÐÐÉèÖÃ¡£				
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
u8 InitI482EBT(void)    
{
	u8 	DataBuf[50], *p, BT_Status=0, Status;    //´òÓ¡»úÉè±¸ÀàÐÍ040680
	u32	i;	  	
	u8  NameFlag=0;
  u8  BtNameStr[30]= {"AT+NAME=T801_BT_"};

	BT_Status = I482_ReadCommand("AT+BAUD?\r", DataBuf);
	if(BT_Status==1)
	{
		USART_BT_InitStructure.USART_BaudRate = 921600;              //2017.03.20  230400 ¸ÄÎª921600 ¼æÈÝÒ»ÍÏ¶àÄ£¿é
		USART_Init(BT_UART, &USART_BT_InitStructure); 	
  }      

  if((BT_Status== 1) || BluetoothStruct.reInitFlag)	             //Èç¹û²»ÊÇ230400£¬Ôò¶ÔÄ£¿é³õÊ¼»¯
	{
		NameFlag =1;
		for (i=0;i<8;i++)
		{
			BT_Status = I482_SetCommand( &I482E_DefaultParameter[i][0]);//Êä³öÀ¶ÑÀÄ£¿éÖ¸Áî
			DelayMs(30);
			if(BT_Status == 1)		
				break;							                                      //³ö´íÍË³ö
		}
		BtParaReloadFlag = 1;																				//2016.09.23
		SysDelay1mS(1500);		                                      //2018.02.28 Ôö¼ÓÑÓÊ± ÈÃ²ÎÊýÕý³£Ð´ÈëÀ¶ÑÀÄ£¿é
	}  
	if(BT_Status ==0)
	{
		
    Status = BC04_ReadCommand( "AT+LBDADDR?\r", DataBuf);	       //²éÑ¯À¶ÑÀÄ£¿éµÄµØÖ·
		if(Status == 0)
		{		
			for(i=0; i<6;i++)
			{
				BluetoothStruct.Laddr[3*i]= DataBuf[9+2*i];
				BluetoothStruct.Laddr[3*i+1]= DataBuf[9+2*i+1];
				BluetoothStruct.Laddr[3*i+2]= ':';
			}
			BluetoothStruct.Laddr[17] = 0;
			//2018.12.19
			BtNameStr[16]= BluetoothStruct.Laddr[12];
			BtNameStr[17]= BluetoothStruct.Laddr[13];
			BtNameStr[18]= BluetoothStruct.Laddr[15];
			BtNameStr[19]= BluetoothStruct.Laddr[16];
			BtNameStr[20]= 0x00;
			
			if(NameFlag==1)   //2018.12.19  À¶ÑÀÃû³ÆÐ´ÈëÄ£¿é
			{
				Status = I482_SetCommand(BtNameStr);
				SystemDelay1mS(1500);		        //2018.12.10 ÑÓÊ± ÊÇµÄÄ£¿éÄÚÀ¶ÑÀÃû³ÆÕýÈ·Ð´Èë
			}	
			NameFlag=0;
		}
		else
		{
			BT_Status =1;
			BluetoothStruct.Laddr[0] = 0;
		}	

		Status = BC04_ReadCommand( "AT+PIN?\r", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄÃÜÂë   
		if(Status == 0)
		{
			p =strchr(DataBuf, ':');
			strcpy(BluetoothStruct.Password, p+1);               
      p=strchr(BluetoothStruct.Password,0x0a);
      if(p!=0)
      {
        *p=0;
      }            
		}
		else
		{
			BT_Status =1;
			BluetoothStruct.Password[0] = 0;
		}

		Status = BC04_ReadCommand( "AT+NAME?\r", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ°ó¶¨×´Ì¬
		if(Status == 0)
		{
			p =strchr(DataBuf, ':');
			strcpy(BluetoothStruct.Name, p+1);
      p=strchr(BluetoothStruct.Name,0x0a);
      if(p!=0)
      {
         *p=0;
      }
		}
		else
		{
			BT_Status =1;
			BluetoothStruct.Name[0] = 0;
		}

	  Status = BC04_ReadCommand( "AT+SSP?\r", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ¼øÈ¨×´Ì¬
		if(Status == 0)
		{
			p =strchr(DataBuf, ':');
			p =strchr(p, '0');   //Èç¹û²é²»µ½¶ÔÓ¦×Ö·û·µ»ØNULL
      p =strchr(DataBuf, '0');
      if(p == NULL)          //²ÎÊý¡®1¡¯±íÊ¾ÐèÒª¼øÈ¨  
      {
         BluetoothStruct.Auth = 0;
      }
      else                   //²ÎÊý¡®0¡¯±íÊ¾²»ÐèÒª¼øÈ¨
      {
         BluetoothStruct.Auth = 1;
      }
		}
		else
		{
			BT_Status =1;
		}
		
		Status = BC04_ReadCommand( "AT+GVER?\r", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ°æ±¾
		if(Status == 0)
		{
			p =strchr(DataBuf, 'B');
			if(p==0)
			{
				p =strchr(DataBuf, 'I');    //2017.03.21  ¼æÈÝi484EÄ£¿é
				strcpy(BluetoothStruct.Version, p);
        p=strchr(BluetoothStruct.Version,0x0a);
        if(p!=0)
				{	
          *p=0;
        }             
			}
			else
      {
				strcpy(BluetoothStruct.Version, p);
        p=strchr(BluetoothStruct.Version,0x0a);
        if(p!=0)
				{	
          *p=0;
				}	
      }                
		}
		else
		{
			BT_Status =1;
			BluetoothStruct.Version[0] = 0;
		}
    Status = BC04_ReadCommand( "AT+CLASS?\r", DataBuf );	 //²éÑ¯À¶ÑÀÄ£¿éµÄ°ó¶¨×´Ì¬   
		if(Status == 0)
		{
			p =strchr(DataBuf, ':');
			strcpy(BluetoothStruct.Class, p+1);
      p=strchr(BluetoothStruct.Class,0x0a);
      if(p!=0)
      {
         *p=0;
      }
		}
		else
		{
			BT_Status =1;
			BluetoothStruct.Class[0] = 0;
		}
		
// 		Status = BC04_ReadCommand( "AT+BTMODE?\r", DataBuf );
	}
    return BT_Status;
}

/*******************************************************************************
* Function Name  : void Init_BT(void)
* Description    : ³õÊ¼»¯À¶ÑÀÄ£¿é£¬ÏÈ¶ÁÄ£¿é´®¿Ú²¨ÌØÂÊ£¬Èç¹û²»Îª115200£¬ÔòÈÏÎª¸ÃÄ£¿éÎªÐÂµÄÄ£¿é£¬
				           Ôò¶ÔÆä°´Ä¬ÈÏ·½Ê½½øÐÐÉèÖÃ¡£				
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/


void Init_BT (void)
{
	uint8_t 	BT_Status=0;
	uint8_t   Temp;
	uint8_t   i;
	uint8_t 	Len,Temp1;    
	volatile FLASH_Status FLASHStatus;     //2016.10.13
	

	
	//2016.10.13  ¶ÁÈ¡ÄÚ²¿flashµ¹ÊýµÚ¶þÒ³ÄÚÀ¶ÑÀ×´Ì¬ 
	Len=1;
	Temp1 = 0;     //Temp=1ÔòÐèÒªÖØÐ´BtOnStatusµ½flash
 	Flash_Inside_ReadByte(&BtOnStatus,BtStatus_FLASH_ADDR, Len);
	
	if(BtOnStatus!=0xAA)				//´æµÄ×´Ì¬ÎªÎ´½ÓÀ¶ÑÀÄ£¿é
	{
		if(g_tInterface.BT_Type == 1)        //ÏÖÔÚ²åÁËÀ¶ÑÀ
		{
			BtOnStatus = 0xAA;
			Temp1 = 1;																 //°ÑBtOnStatus×´Ì¬Ð´Èëflash
			BluetoothStruct.reInitFlag = 1;          //ÐèÒªÖØÐ´À¶ÑÀ²ÎÊý
		}	
    else if(BtOnStatus!=0x55)
    {
			BtOnStatus = 0x55;
			Temp1 = 1;	
		}			
	}	
	else if(BtOnStatus==0xAA)										//×´Ì¬ÎªÖ®Ç°ÓÐÀ¶ÑÀ
	{
		if(g_tInterface.BT_Type != 1)        //ÏÖÔÚÃ»ÓÐÀ¶ÑÀ
		{
			BtOnStatus = 0x55;
			Temp1 = 1;																 //°ÑBtOnStatus×´Ì¬Ð´Èëflash
		}	
	}	
		
	if(Temp1 == 1)			//À¶ÑÀ×´Ì¬ÓÐ¸Ä±ä  ÖØÐ´Ð´Èëflash
	{	
		//°´ÕÕ°ë×ÖÐ´ÈëÄÚ²¿FLASH
		FLASH_Unlock();     //ÏÈ½â³ýFlashËø
		FLASH_ClearFlag(FLASH_FLAG_BSY | FLASH_FLAG_EOP | FLASH_FLAG_PGERR | FLASH_FLAG_WRPRTERR);    //Çå±êÖ¾Î»
		FLASHStatus = FLASH_ErasePage(BtStatus_FLASH_ADDR);  //Ò³²Á³ý
		if (FLASHStatus == FLASH_COMPLETE)                      
		//Èç¹ûÒ³²Á³ý³É¹¦,¿ªÊ¼Ð´Èë,·ñÔòÖ±½ÓÍË³ö
		{   //±à³Ì²¢Ð£Ñé,Ã¿´ÎÐ´Èë16Î»,´«ËÍ²ÎÊý°´ÕÕ×Ö½Ú¼ÆËã
 				FLASHStatus = Flash_Inside_BufWrite(&BtOnStatus, BtStatus_FLASH_ADDR, Len);
		}
		FLASH_Lock();  
		DelayUs(60000);
	}		
	
	if(g_tInterface.BT_Type == 0)	
	{
		return;
	}	
	DelayUs(250000);
	BluetoothStruct.Type = DMBT;	  //2016.07.22 ¹Ì¶¨½ðê±2.0 GCJO  JOBT4 DMBTË«Ä£
	
 	InitBluetoothPort();	
	InitBTUsart();
	
// 	BT_RST_HIGH;									  //¸´Î»À¶ÑÀÄ£¿é
	BT_BUSY_CLR;				            //ÇåÀ¶ÑÀÄ£¿é½Ó¿ÚÃ¦ 		
	

  if(g_tInterface.BT_Type == 1)
	{	
    OpenSetupBluetooth();				  //½øÈëÉèÖÃ·½Ê½
  }
    
  switch(BluetoothStruct.Type)
	{		

		//½ðê±Ä£¿é
// 		case JOBT4:
// 		case GCJO:
// 				BT_Status = InitJOBT(); 
// 				break;
		case DMBT:
        BT_Status = InitI482EBT(); 
		    break;
		default: 
				break;
	}
       	
   if(g_tInterface.BT_Type == 1)
	 { 
      CloseSetupBluetooth();					//ÍË³öÉèÖÃ·½Ê½
   }
	 BluetoothStruct.InitFlag = 1;	

	if( BT_Status  )		 				//Ä£¿éÍ¨Ñ¶´íÎó
	{
		while(1)
		{
			SysDelay1mS(400);
		}
	}
}

/*******************************************************************************
* Function Name  : Read_NByte(uint8_t Length, uint8_t *DataBuf)
* Description    : ¶ÁÈëÖ¸Áî×Ö½ÚÊý¾Ý×é³É×Ö·û´®
* Input          : Length£º×Ö½ÚÊý£¬DataBuf£º×Ö·û´®µØÖ·
* Output         : None
* Return         : None
*******************************************************************************/
void Read_NByte(uint32_t Length, uint8_t *DataBuf)
{
	uint32_t i;
	for(i=0; i<Length; i++)
		DataBuf[i] = ReadInBuffer();
	DataBuf[i] =0;
}

/*******************************************************************************
* Function Name  : uint8_t Judge_BT_Link(void)
* Description    : ÅÐ¶ÏÀ¶ÑÀÊÇ·ñÁ´½Ó£¬·µ»Ø1±íÊ¾Á´½Ó£¬0±íÊ¾Î´Á´½Ó
				   BM57ºÍGC04/BC04µÄÁ´½ÓÖ¸Ê¾µçÆ½Ïà·´¡£
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
uint8_t Judge_BT_Link(void)
{
	u16  Count,Temp;
	static u16	BTCount=0,BTCount1=0;			//¼ÆÊýÊ±¼ä
	static u8   Flag = 0;
	static u8   FLAG_BT_LINK = 0;
	
	Count = 500;   //ÐÝÃßÊ±Á´½ÓÊ±¼ä Î´ÓÃ
	if(BluetoothStruct.InitFlag == 0)	 			//À¶ÑÀ³õÊ¼»¯Î´Íê³É£¬²»ÉÁË¸Á´½ÓÖ¸Ê¾µÆ
	{
		return 0;	
	}

	
	if(BluetoothStruct.Type == DMBT)  //Ë«Ä£À¶ÑÀ I482E
	{  
		if(READ_BT_LINK)
		{
			BTCount1++;
		}
		else
		{
			BTCount=BTCount1;
			BTCount1=0;
			if(BTCount>=400)                   //Á´½ÓÐÅºÅ  
			{
				//±íÊ¾Á´½ÓÉÏÁË
				FLAG_BT_LINK=1;
			}
			else if(BTCount>60 &&BTCount<200)  //¶Ï¿ªÐÅºÅ 
			{
				FLAG_BT_LINK=0;
			}
		}     
		return FLAG_BT_LINK;
	}
	else
	{	
		return 0;
	}	
}

/*******************************************************************************
                                À¶ÑÀÉèÖÃÖ¸Áî²¿·Ö
*******************************************************************************/

/*******************************************************************************
* Function Name  : SetCommand_1F5908
* Description    : Çå³ýÀ¶ÑÀ°ó¶¨µØÖ·
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5908( void )
{
	u8 ErrInfor;
	
	ErrInfor = 0xFE;
    
	if( BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4)
			USART_SendStr(BT_UART,"AT+CLEARADDR\r\n");	
	else
			UpLoadData(&ErrInfor, 1);	//ÉÏ´«Êý¾Ý
}

/*******************************************************************************
* Function Name  : SetCommand_1F5909
* Description    : ÉèÖÃ¶àÁ¬½Ó  2020.05.28
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5909( void )
{
	uint8_t DataBuf[10],Status,Bind,Getchar;
	
	Status =1;
	
  if(BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4 || BluetoothStruct.Type == DMBT)
	{    
    Getchar =ReadInBuffer();	
    if(Getchar == 1)
    {
			DataBuf[0]=0x31;
    }			
		else
		{
			DataBuf[0]=0x30;
    }	
		DataBuf[1]=0;
		USART_SendStr(BT_UART,"AT+MULTICONN=");
		Status = BC04_SetCommand(DataBuf);	    
	}
  if(Status == 0)
  {
		 UpLoadData("OK", 2);	//ÉÏ´«Êý¾Ý
		 if(g_tSysConfig.SysLanguage == 1)
				 PrintString("ÉèÖÃ¶àÁ´½Ó£º");	
		 else
				 PrintString("Set Done:");	
		 if(Getchar==1)
		 {
				PrintString("ON");
     } 
		 else
		 {
				PrintString("OFF");
     }	 
		 PrintString("\r\n");
  }
  else
  {
		 UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
		 PrintString("Set Failed\r\n");	
  }
  GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ 
}
/*******************************************************************************
* Function Name  : SetCommand_1F5901
* Description    : ÉèÖÃÀ¶ÑÀ´®¿Ú²ÎÊý
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5901( void )
{
    u8 BpsTemp;    
    BpsTemp = 0xFE;
    
    UpLoadData(&BpsTemp, 1);	//ÉÏ´«Êý¾Ý				
}
/*******************************************************************************
* Function Name  : SetCommand_1F5902
* Description    : ÉèÖÃÀ¶ÑÀÃÜÂë
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5902( void )
{
	uint8_t DataBuf[40],parameter,Status;
	uint32_t Number;
	Number =ReadInBuffer();
	Read_NByte(Number,DataBuf );
  
	if(Number < 4)
	{
		UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
		return;
	}
		
	if( BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4)           //À¶ÑÀÃÜÂëÎª4~8Î»
	{
		if(Number > 8)
		{            
			Number = 8;
			DataBuf[Number] = 0;	
		}      		    		 
		USART_SendStr(BT_UART,"AT+PASSWORD=");
		Status = BC04_SetCommand(DataBuf);	      
	}
	else if( BluetoothStruct.Type == DMBT)            
	{
		if(Number > 8)
		{            
		  Number = 8;
			DataBuf[Number] = 0;	
		}      		    		 
		USART_SendStr(BT_UART,"AT+PIN=");
		Status = I482_SetCommand(DataBuf);	      
	}
  if(Status == 0)
  {
		 UpLoadData("OK", 2);	//ÉÏ´«Êý¾Ý
		 if(g_tSysConfig.SysLanguage == 1)
				 PrintString("À¶ÑÀÃÜÂë£º");	
		 else
				 PrintString("Bluetooth Password:");	
		 PrintString(DataBuf);
		 PrintString("\r\n");
  }
  else
  {
		 UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
		 PrintString("Set Bluetooth Password Failed\r\n");
  }
  GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ
}
/*******************************************************************************
* Function Name  : SetCommand_1F5903
* Description    : ÉèÖÃÖ÷´Ó½ÇÉ« 
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5903( void )
{
	uint8_t DataBuf[40],Status,Role;  
	u8 ErrInfor;
	
	ErrInfor = 0xFE;     
  if(BluetoothStruct.Type == DMBT)    //²»Ö§³ÖÖ÷Ä£Ê½
	{
		UpLoadData(&ErrInfor, 1);	         //ÉÏ´«Êý¾Ý
	  return;
  }    
	Read_NByte(1,DataBuf );
	DataBuf[0] |= 0x30;
	Role = DataBuf[0];
	if(BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4)
	{     
			USART_SendStr(BT_UART,"AT+ROLE=");
			Status = BC04_SetCommand(DataBuf);	  
	}
	else
	{

	}	
	if(Status == 0)
	{
			UpLoadData("OK", 2);	//ÉÏ´«Êý¾Ý
			if(g_tSysConfig.SysLanguage == 1)
			{
				PrintString("À¶ÑÀÄ£Ê½£º");	
				if(Role == 0x30)
						PrintString("´Ó");
				else
						PrintString("Ö÷");
			}
			else
			{
				PrintString("Bluetooth Role:");
				if(Role == 0x30)
						PrintString("Slave");
				else
						PrintString("Host");
			}           
			PrintString("\r\n");
	}
	else
	{
			UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
			PrintString("Set Bluetooth Role Failed\r\n");
	}
	GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ
}

/*******************************************************************************
* Function Name  : SetCommand_1F5904
* Description    : ÉèÖÃµØÖ·°ó¶¨
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5904( void )
{
	uint8_t DataBuf[40],Status,Bind,ErrInfor;
    
  ErrInfor = 0xFE; 
  if( BluetoothStruct.Type == DMBT)
	{
		UpLoadData(&ErrInfor, 1);    	//ÉÏ´«Êý¾Ý ²»Ö§³Ö
		return;
	}  
	Read_NByte(1,DataBuf );
	DataBuf[0] |= 0X30;	
	Bind = DataBuf[0];
	if(BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4)
	{     
		USART_SendStr(BT_UART,"AT+BIND=");
		Status = BC04_SetCommand(DataBuf);
		if(Status == 0)
		{
			 Status = BC04_SetCommand("AT+CLEARADDR");	
		}    
	}
	else
	{		
	}
	if(Status == 0)
	{
		UpLoadData("OK", 2);	//ÉÏ´«Êý¾Ý
		if(g_tSysConfig.SysLanguage == 1)
		{
			PrintString("À¶ÑÀ°ó¶¨Ä£Ê½£º");	
			if(Bind == 0x30)
					PrintString("µØÖ·²»°ó¶¨");
			else
					PrintString("µØÖ·°ó¶¨");
		}
		else
		{
			PrintString("Bluetooth Bind:");
			if(Bind == 0x30)
					PrintString("Address is not binding");
			else
					PrintString("Address binding");
		}           
		PrintString("\r\n");
	}
	else
	{
		UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
		PrintString("Set Bluetooth Bind Failed\r\n");
	}
	GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ
}
/*******************************************************************************
* Function Name  : SetCommand_1F5905
* Description    : ÉèÖÃÀ¶ÑÀÉè±¸Ãû³Æ
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5905( void )
{
	uint8_t DataBuf[40],parameter,Status;
	uint32_t Number;
	Number =ReadInBuffer();
	Read_NByte(Number,DataBuf );
  if(Number > 16)                                             
	{
		Number = 16;
    DataBuf[Number] = 0;		    
	}
	if(BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4 || BluetoothStruct.Type == DMBT)
	{      
		USART_SendStr(BT_UART,"AT+NAME=");
		Status = BC04_SetCommand(DataBuf);	    
	}
  if(Status == 0)
  {
		 UpLoadData("OK", 2);	//ÉÏ´«Êý¾Ý
		 if(g_tSysConfig.SysLanguage == 1)
				 PrintString("À¶ÑÀÃû³Æ£º");	
		 else
				 PrintString("Bluetooth Name:");	
		 PrintString(DataBuf);
		 PrintString("\r\n");
  }
  else
  {
		 UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
		 PrintString("Set Bluetooth Name Failed\r\n");	
  }
  GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ 
}
/*******************************************************************************
* Function Name  : SetCommand_1F5906
* Description    : ÉèÖÃÀ¶ÑÀÉè±¸ÀàÐÍ
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5906( void )
{
	uint8_t DataBuf[10],DataBuf1[10],BT_Class[3],Status,i,ErrInfor;
	uint32_t Number;

  ErrInfor = 0xFE;
           
	Number =ReadInBuffer();
	Read_NByte(Number,DataBuf );
  if(Number != 6)
	{
		UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
		return;		    
	}
  if(BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4 || BluetoothStruct.Type == DMBT)
	{
		if(Number != 6)
		{
			UpLoadData("ERROR", 5);     	//ÉÏ´«Êý¾Ý
		  return;		    
		}      
		USART_SendStr(BT_UART,"AT+CLASS=");
		Status = BC04_SetCommand(DataBuf);    
	}
	if(Status == 0)
	{
			UpLoadData("OK", 2);	        //ÉÏ´«Êý¾Ý
			if(g_tSysConfig.SysLanguage == 1)
					PrintString("À¶ÑÀÉè±¸ÀàÐÍ£º");	
			else
					PrintString("Bluetooth Class:");	
			PrintString(DataBuf);
			PrintString("\r\n");
	}
	else
	{
			UpLoadData("ERROR", 5);	    //ÉÏ´«Êý¾Ý
			PrintString("Set Bluetooth Class Failed\r\n");
	}
	GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ
}		
/*******************************************************************************
* Function Name  : SetCommand_1F5907
* Description    : ÉèÖÃÉèÖÃÀ¶ÑÀÃÜÂëÊ¹ÄÜ
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SetCommand_1F5907( void )
{
	uint8_t DataBuf[10],DataBuf1[10],Status;

	Read_NByte(1,DataBuf );
	DataBuf[0] |= 0x30;	
  DataBuf1[0] = DataBuf[0];
  if(BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4)
  {
		USART_SendStr(BT_UART,"AT+AUTH=");
		Status = BC04_SetCommand(DataBuf);	
		DataBuf1[0] = DataBuf[0];
		DataBuf1[1] = '\0';   
  }
	else if(BluetoothStruct.Type == DMBT)   
	{
		if(DataBuf[0] == 0x30)	
			DataBuf[0] = 0x31;
		else if(DataBuf[0] == 0x31)
			DataBuf[0]= 0x30;
		USART_SendStr(BT_UART,"AT+SSP=");
		Status = BC04_SetCommand(DataBuf);
		if(DataBuf[0] == 0x30)	
			DataBuf[0] = 0x31;
		else if(DataBuf[0] == 0x31)
			DataBuf[0]= 0x30;			
		DataBuf1[0] = DataBuf[0];
		DataBuf1[1] = '\0';   
	}
  if(Status == 0)
  {
		 UpLoadData("OK", 2);	//ÉÏ´«Êý¾Ý
		 if(g_tSysConfig.SysLanguage == 1)
		 {
				 PrintString("À¶ÑÀÃÜÂëÊ¹ÄÜ£º");
				 if(DataBuf1[0] == 0x30 )
						 PrintString("·ñ");
				 else
						 PrintString("ÊÇ");
		 }
		 else
		 {
				 PrintString("Bluetooth Auth:");	
				 if(DataBuf1[0] == 0x30 )
						 PrintString("No");
				 else
						 PrintString("Yes");    
		 }
		 PrintString("\r\n");
  }
  else
  {
	  UpLoadData("ERROR", 5);	//ÉÏ´«Êý¾Ý
	  PrintString("Set Bluetooth Auth Failed\r\n");
  }
  GoDotLine(CUT_OFFSET + NO_CUT_OFFSET);			//×ßµ½ËºÖ½Î»ÖÃ
}
/*******************************************************************************
* Function Name  : Command_1D1F
* Description    : ·µ»ØÀ¶ÑÀÐ£ÑéµØÖ·
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void Command_1D1F(void)
{

	u32	CheckSum=0,Temp;
	u8	GetChar,Data[5];		//
	u8	Ch,*p,i=0;

	GetChar = ReadInBuffer();
	if(GetChar==0x00 ||GetChar==0x30)  	   //À¶ÑÀ½Ó¿Ú
	{
		p= BluetoothStruct.Laddr;
	}
	else
	{
		p=&i;							  //¿ÕÖ¸Õë
	}
	while( *p )							  //¼ÆËã·Ö×éÐ£ÑéºÍ
	{
		Ch = *p;
		if(Ch >=0x20 && Ch !=0x3A)
		{
	  		if( Ch>= 0x61)
				Ch -=0x20;
			CheckSum +=	Ch << 8*(i%4);
			i++;
		}
		p++;
	}	
	CheckSum ^=0x69505254;			//"iPRT"
	for(i=0; i<4; i++)					//½«32Î»×ª»»Îª4¸ö8Î»Êý¾Ý£¬ÒÔ·½±ã·¢ËÍ
	{
		Data[i] = CheckSum >> (3-i)*8;
	}

	UpLoadData(Data, 4);					//ÉÏ´«Êý¾Ý								
}
/*******************************************************************************
* Function Name  : void SetBluetooth(u8 FCommand,u8 SCommand)
* Description    : ÉèÖÃÀ¶ÑÀ²ÎÊý
* Input          : Command£ºÉèÖÃÖ¸Áî
* Output         : None
* Return         : None
*******************************************************************************/
void SetBluetooth(u8 FCommand,u8 SCommand)
{
    u8 GetChar,CmdData[40],i;
    
    if( FCommand == 0x1b )
    {    
        switch( SCommand )
        {
//             case 0x0d:
//             {
//                 SetCommand_1F5908();	//Çå³ý°ó¶¨µØÖ·
// 								Set_BTWFflg = 1;
//                 break;
//             }
            case 0x0f:
            {
                SetCommand_1F5901();	   //ÉèÖÃ²¨ÌØÂÊ
                break;
            }
            case 0x10:			
            {
                SetCommand_1F5902();		//ÉèÖÃÃÜÂë
							Set_BTWFflg = 1;
                break;
            }
            case 0x11:			
            {
                SetCommand_1F5903();		//ÉèÖÃÖ÷´Ó½ÇÉ«
							Set_BTWFflg = 1;
                break;
            }
            case 0x12:			
            {
                SetCommand_1F5904();		//ÉèÖÃµØÖ·°ó¶¨
							Set_BTWFflg = 1;
                break;
            }
            case 0x13:			
            {
                SetCommand_1F5905();		//ÉèÖÃÉè±¸Ãû³Æ
							 Set_BTWFflg = 1;
                break;
            }
            case 0x14:			
            {
                SetCommand_1F5906();		//ÉèÖÃÉè±¸ÀàÐÍ
							Set_BTWFflg = 1;
                break;
            }
            case 0x27:			
            {
                SetCommand_1F5907();		//ÉèÖÃÀ¶ÑÀÃÜÂëÊ¹ÄÜ
							Set_BTWFflg = 1;
                break;
            }
            default:                
                break;
        }
   }
	 else if(FCommand ==0x1F)
	 {	 
		  if(SCommand == 0x59)
			{	
				  GetChar =ReadInBuffer();		     //2016.08.13  ¶ÁÈ¡µÚ¶þÎ»²ÎÊý
					switch( GetChar )
					{						
							case 0x01:
							{
									SetCommand_1F5901();	   //ÉèÖÃ²¨ÌØÂÊ
									break;
							}
							case 0x02:			
							{
									SetCommand_1F5902();		//ÉèÖÃÃÜÂë
								  Set_BTWFflg = 1;
									break;
							}
							case 0x03:			
							{
									SetCommand_1F5903();		//ÉèÖÃÖ÷´Ó½ÇÉ«
								Set_BTWFflg = 1;
									break;
							}
							case 0x04:			
							{
									SetCommand_1F5904();		//ÉèÖÃµØÖ·°ó¶¨
								Set_BTWFflg = 1;
									break;
							}
							case 0x05:			
							{
									SetCommand_1F5905();		//ÉèÖÃÉè±¸Ãû³Æ
								Set_BTWFflg = 1;
									break;
							}
							case 0x06:			
							{
									SetCommand_1F5906();		//ÉèÖÃÉè±¸ÀàÐÍ
								Set_BTWFflg = 1;
									break;
							}
							case 0x07:			
							{
									SetCommand_1F5907();		//ÉèÖÃÀ¶ÑÀÃÜÂëÊ¹ÄÜ
								Set_BTWFflg = 1;
									break;
							}
							case 0x08:
							{
									SetCommand_1F5908();	//Çå³ýÀ¶ÑÀÄ£Ê½°ó¶¨µØÖ·
									break;
							}
							case 0x09:
							{
									SetCommand_1F5909();	//ÉèÖÃ¶àÁ¬½Ó
									break;
							}
							default:                
									break;
					}
		  }
			else
			{
		
			}	
	 }	 
   else if(FCommand =='A' && (BluetoothStruct.Type == GCJO || BluetoothStruct.Type == JOBT4))	  //Ô¤ÁôÀ¶ÑÀATÖ¸Áî
	 {
			CmdData[0]=	FCommand;
			CmdData[1]=	SCommand;
			for(i=1; i<36; i++)
			{
				CmdData[i] = ReadInBuffer();
				if(CmdData[i] ==0x0a)
				{
					CmdData[i+1] =0;
					break;
				}
			}
			if(i<36)
			{
				if(strchr(CmdData,'?'))		
				{
					BC04_ReadCommand(CmdData,CmdData);		//¶Á²ÎÊýÖ¸Áî
					UpLoadData(CmdData, strlen(CmdData));	//ÉÏ´«Êý¾Ý
				}
				else
				{
					BC04_SetCommand(CmdData);	//ÉèÖÃÖ¸Áî
				}
			}
	}
}

/******************* (C) COPYRIGHT 2016 *****END OF FILE****/
